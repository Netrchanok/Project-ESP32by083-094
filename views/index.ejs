<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Dashboard</title>
  <link rel="stylesheet" href="/css/main.css">
  <style>
    /* --- Sensor Table Style --- */
    .sensor-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .sensor-table th, .sensor-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    .sensor-table th {
      background-color: rgba(0, 0, 0, 0.03);
      font-weight: bold;
      color: #333;
    }
    .sensor-table tr:last-child td { border-bottom: none; }
    .sensor-table tr:nth-child(even) { background-color: rgba(0, 0, 0, 0.02); }

    /* --- Weather Card --- */
    .card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    .card h3 {
      margin: 0;
      font-size: 1.5em;
      color: #2c3e50;
    }
    .card p {
      margin: 8px 0;
      font-size: 1.1em;
      color: #333;
    }
    .card small {
      color: #666;
      font-size: 0.9em;
      display: block;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üå§Ô∏è Weather Dashboard</h1>
    <div class="search-container">
      <form action="/" method="GET">
        <input type="text" name="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î..." class="search-input" value="<%= typeof query !== 'undefined' ? query : '' %>">
        <button type="submit" class="search-button">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </form>
    </div>

    <!-- Sensor Data Section -->
    <% if (typeof sensorData !== 'undefined' && sensorData.length > 0) { %>
      <div class="card">
        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå (ESP32)</h3>
        <table class="sensor-table">
          <thead>
            <tr>
              <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
              <th>üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)</th>
              <th>üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</th>
            </tr>
          </thead>
          <tbody>
            <% sensorData.forEach(sensor => { %>
              <tr>
                <td><%= sensor.formattedTimestamp %></td>
                <td><%= sensor.temperature.toFixed(2) %></td>
                <td><%= sensor.humidity.toFixed(2) %></td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <div class="card" style="text-align: center;">
        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå (ESP32)</h3>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
      </div>
    <% } %>

    <!-- Weather Data Section -->
    <% regions.forEach(region => { %>
      <% if (typeof region.provinces !== 'undefined' && region.provinces.length > 0) { %>
        <h2><%= region._id %></h2>
        <div class="weather-grid">
          <% region.provinces.forEach(p => { %>
          <div class="card">
            <div class="card-header">
              <img src="https://openweathermap.org/img/wn/<%= p.icon %>@2x.png" alt="Weather icon" width="50" height="50">
              <h3><%= p.city %></h3>
            </div>
            <p><strong>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥:</strong> <%= p.temp.toFixed(1) %> ¬∞C</p>
            <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô:</strong> <%= p.humidity %> %</p>
            <p><strong>‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®:</strong> <%= p.weather %></p>
            <small>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: <%= p.formattedTimestamp %></small>
          </div>
          <% }) %>
        </div>
      <% } %>
    <% }) %>

    <% if (typeof regions !== 'undefined' && regions.length === 0 && (!query || query.trim() === '')) { %>
      <div class="card" style="text-align: center;">
        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</p>
      </div>
    <% } else if (typeof regions !== 'undefined' && regions.length === 0 && query && query.trim() !== '') { %>
      <div class="card" style="text-align: center;">
        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î "<%= query %>"</p>
      </div>
    <% } %>
  </div>
</body>
</html>
